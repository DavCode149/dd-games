<!DOCTYPE html>
<html>
<head>
<title>Chat</title>
<style>
body {
  margin:0;
  font-family:Arial;
  background:#0f172a;
  color:white;
  display:flex;
  flex-direction:column;
  height:100vh;
}
#topBar {
  display:flex;
  gap:10px;
  padding:10px;
  background:#020617;
}
select, input, button {
  padding:8px;
  border:none;
  border-radius:6px;
}
#messages {
  flex:1;
  overflow-y:auto;
  padding:10px;
}
.msg {
  margin-bottom:6px;
  padding:6px 10px;
  background:#1e293b;
  border-radius:8px;
}
.name {
  color:#38bdf8;
  font-weight:bold;
}
#inputBar {
  display:flex;
  border-top:2px solid #1e293b;
}
#msgInput {
  flex:1;
}
</style>
</head>
<body>

<div id="topBar">
  <select id="conversationSelect"></select>
</div>

<div id="messages"></div>

<div id="inputBar">
  <input id="msgInput" placeholder="Type message..." />
  <button onclick="sendMessage()">Send</button>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
const supabase = createClient(
  "https://lqfcntoldutgkzaboqfk.supabase.co",
  "sb_publishable_Zs0J8nka95CzLZJ7BWqEAg_sqD5Wr0d"
);

/* CONFIG */
const bannedWords=["badword1","badword2"];

/* DEVICE ID */
function getID(){
  let id=localStorage.getItem("device_id");
  if(!id){
    id=crypto.randomUUID();
    localStorage.setItem("device_id",id);
  }
  return id;
}
const deviceID=getID();

/* ELEMENTS */
const convoSelect=document.getElementById("conversationSelect");
const messagesDiv=document.getElementById("messages");
const input=document.getElementById("msgInput");

/* CENSOR */
function censor(text){
  let t=text;
  bannedWords.forEach(w=>{
    t=t.replace(new RegExp(w,"gi"),"#".repeat(w.length));
  });
  return t;
}

/* LOAD ME */
const { data: me } = await supabase
  .from("users")
  .select('"Name", premium, muted, blocked')
  .eq("user_id",deviceID)
  .maybeSingle();

if(!me || me.blocked){
  document.body.innerHTML="<h1>You have been banned from DD Games for breaking the TOS.</h1>";
  throw "blocked";
}

if(!me.premium){
  document.body.innerHTML="<h1>Chat is a Premium feature</h1>";
  throw "not premium";
}

if(me.muted){
  input.disabled=true;
  input.placeholder="Muted";
}

/* GET PUBLIC CONVO */
let publicConvo;
let { data: pub } = await supabase
  .from("conversations")
  .select("*")
  .eq("is_public",true)
  .maybeSingle();

if(!pub){
  const { data:newPub } = await supabase
    .from("conversations")
    .insert({is_public:true})
    .select()
    .single();
  publicConvo=newPub;
}else{
  publicConvo=pub;
}

/* LOAD USERS */
const { data: users } = await supabase
  .from("users")
  .select('user_id,"Name"');

/* BUILD DROPDOWN */
function buildDropdown(){
  convoSelect.innerHTML="";
  const opt=document.createElement("option");
  opt.value=publicConvo.id;
  opt.textContent="ðŸŒ Public Chat";
  convoSelect.appendChild(opt);

  users.forEach(u=>{
    if(u.user_id===deviceID) return;
    const o=document.createElement("option");
    o.value=u.user_id;
    o.textContent="DM: "+(u.Name||u.user_id);
    convoSelect.appendChild(o);
  });
}
buildDropdown();

let currentConversationId=publicConvo.id;

/* SWITCH */
convoSelect.onchange=async()=>{
  const val=convoSelect.value;
  if(val===publicConvo.id){
    currentConversationId=publicConvo.id;
    loadMessages();
  } else {
    currentConversationId=await getOrCreateDM(val);
    loadMessages();
  }
};

/* CREATE DM */
async function getOrCreateDM(otherUser){
  const { data: convos } = await supabase
    .from("conversation_members")
    .select("conversation_id")
    .eq("user_id",deviceID);

  for(const c of convos){
    const { data: members } = await supabase
      .from("conversation_members")
      .select("user_id")
      .eq("conversation_id",c.conversation_id);

    if(members.length===2 &&
       members.some(m=>m.user_id===otherUser)){
      return c.conversation_id;
    }
  }

  const { data:newConvo } = await supabase
    .from("conversations")
    .insert({is_public:false})
    .select()
    .single();

  await supabase.from("conversation_members").insert([
    {conversation_id:newConvo.id,user_id:deviceID},
    {conversation_id:newConvo.id,user_id:otherUser}
  ]);

  return newConvo.id;
}

/* SEND */
window.sendMessage=async()=>{
  const txt=input.value.trim();
  if(!txt) return;
  await supabase.from("messages").insert({
    conversation_id: currentConversationId,
    user_id: deviceID,
    content: censor(txt)
  });
  input.value="";
};

/* NAME CACHE */
const nameCache={};
async function getName(id){
  if(nameCache[id]) return nameCache[id];
  const { data } = await supabase.from("users")
    .select('"Name"')
    .eq("user_id",id)
    .maybeSingle();
  const n=data?.Name||"Unknown";
  nameCache[id]=n;
  return n;
}

/* LOAD MESSAGES */
async function loadMessages(){
  const { data } = await supabase
    .from("messages")
    .select("*")
    .eq("conversation_id",currentConversationId)
    .order("created_at",{ascending:true});

  messagesDiv.innerHTML="";
  for(const m of data){
    const div=document.createElement("div");
    div.className="msg";
    const name=await getName(m.user_id);
    div.innerHTML=`<span class="name">${name}</span>: ${m.content}`;
    messagesDiv.appendChild(div);
  }
  messagesDiv.scrollTop=messagesDiv.scrollHeight;
}
loadMessages();

/* REALTIME */
supabase.channel("chat")
  .on("postgres_changes",{event:"INSERT",table:"messages"},payload=>{
    if(payload.new.conversation_id===currentConversationId){
      loadMessages();
    }
  })
  .subscribe();

/* AUTO DELETE 6H */
setInterval(async()=>{
  const t=new Date(Date.now()-21600000).toISOString();
  await supabase.from("messages").delete().lt("created_at",t);
},60000);

</script>
</body>
</html>