<!DOCTYPE html>
<html>
<head>
<title>DD Chat - Test</title>
<style>
body {
  margin:0;
  font-family:Arial;
  background:#0f172a;
  color:white;
  display:flex;
  flex-direction:column;
  height:100vh;
}
#messages {
  flex:1;
  overflow-y:auto;
  padding:10px;
}
.msg {
  background:#1e293b;
  margin-bottom:8px;
  padding:8px;
  border-radius:8px;
}
.name {
  font-weight:bold;
  color:#38bdf8;
}
.time {
  font-size:12px;
  color:#94a3b8;
}
.deleteBtn, .muteBtn {
  color:red;
  cursor:pointer;
  font-size:12px;
  margin-left:6px;
}
.hashtag {
  color:#22c55e;
}
#input {
  display:flex;
  padding:10px;
  background:#020617;
}
input {
  flex:1;
  padding:10px;
  border-radius:8px;
  border:none;
}
button {
  margin-left:8px;
  padding:10px;
  border-radius:8px;
  border:none;
  cursor:pointer;
}
</style>
</head>
<body>

<div id="messages"></div>

<div id="input">
  <input id="msgInput" placeholder="Type a message...">
  <button onclick="sendMessage()">Send</button>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://lqfcntoldutgkzaboqfk.supabase.co",
  "sb_publishable_Zs0J8nka95CzLZJ7BWqEAg_sqD5Wr0d"
);

/* CONFIG */
const MOD_USERS = [
  "PUT-YOUR-DEVICE-ID-HERE"
];

const HASHTAG_WORDS = ["game","update","bug","help","news"];

/* DEVICE ID */
function getDeviceID(){
  let id = localStorage.getItem("device_id");
  if(!id){
    id = crypto.randomUUID();
    localStorage.setItem("device_id", id);
  }
  return id;
}

const deviceID = getDeviceID();

/* GET USER */
const { data: userRow } = await supabase
  .from("users")
  .select('"Name", muted')
  .eq("user_id", deviceID)
  .maybeSingle();

const userName = userRow?.Name || "Guest";
let isMuted = userRow?.muted || false;

/* FORMAT MESSAGE */
function applyHashtags(text){
  HASHTAG_WORDS.forEach(word=>{
    const regex = new RegExp(`\\b${word}\\b`,"gi");
    text = text.replace(regex, `#${word}`);
  });
  return text;
}

function formatText(text){
  return text.replace(/#(\w+)/g,'<span class="hashtag">#$1</span>');
}

/* LOAD MESSAGES */
async function loadMessages(){
  const { data } = await supabase
    .from("messages")
    .select("*")
    .order("created_at",{ascending:true});

  renderMessages(data);
}

supabase
  .channel("realtime-messages")
  .on(
    "postgres_changes",
    { event: "*", schema: "public", table: "messages" },
    payload => {
      loadMessages(); // reload when anything changes
    }
  )
  .subscribe();

function renderMessages(data){
  const box = document.getElementById("messages");
  box.innerHTML="";

  data.forEach(m=>{
    const div=document.createElement("div");
    div.className="msg";

    let controls = "";
    if(MOD_USERS.includes(deviceID)){
      controls = `
        <span class="deleteBtn" onclick="deleteMsg('${m.id}')">[delete]</span>
        <span class="muteBtn" onclick="muteUser('${m.user_id}')">[mute]</span>
      `;
    }

    div.innerHTML = `
      <div class="name">${m.name} ${controls}</div>
      <div>${formatText(m.message)}</div>
      <div class="time">${new Date(m.created_at).toLocaleTimeString()}</div>
    `;
    box.appendChild(div);
  });

  box.scrollTop = box.scrollHeight;
}

/* REALTIME */
supabase.channel("chat-room")
  .on(
    "postgres_changes",
    { event: "*", schema: "public", table: "messages" },
    payload => {
      loadMessages();
    }
  )
  .subscribe();

/* SEND MESSAGE */
window.sendMessage = async function(){
  if(isMuted){
    alert("You are muted.");
    return;
  }

  const input=document.getElementById("msgInput");
  let msg=input.value.trim();
  if(!msg) return;

  msg = applyHashtags(msg);

  await supabase.from("messages").insert({
    user_id: deviceID,
    name: userName,
    message: msg
  });

  input.value="";
};

/* DELETE MESSAGE */
window.deleteMsg = async function(id){
  await supabase.from("messages").delete().eq("id",id);
};

/* MUTE USER */
window.muteUser = async function(uid){
  await supabase.from("users").update({ muted:true }).eq("user_id",uid);
  alert("User muted");
};

/* INITIAL LOAD */
loadMessages();

/* CHECK MUTE STATUS LIVE */
setInterval(async ()=>{
  const { data } = await supabase
    .from("users")
    .select("muted")
    .eq("user_id",deviceID)
    .maybeSingle();

  isMuted = data?.muted || false;
},5000);

</script>

</body>
</html>