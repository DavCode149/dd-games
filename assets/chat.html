<!DOCTYPE html>
<html>
<head>
<title>DD Games - Chat Test</title>
<style>
body {
  margin:0;
  font-family:Arial;
  background:#0f172a;
  color:white;
  display:flex;
  flex-direction:column;
  height:100vh;
}
#messages {
  flex:1;
  overflow-y:auto;
  padding:10px;
}
.msg {
  margin-bottom:8px;
  padding:6px 10px;
  background:#1e293b;
  border-radius:8px;
}
.admin {
  color:#38bdf8;
}
#inputBar {
  display:flex;
  border-top:2px solid #1e293b;
}
input {
  flex:1;
  padding:12px;
  border:none;
  outline:none;
}
button {
  padding:12px;
  border:none;
  cursor:pointer;
}
</style>
</head>
<body>

<div id="messages"></div>

<div id="inputBar">
  <input id="msgInput" placeholder="Type a message..." />
  <button onclick="sendMessage()">Send</button>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://lqfcntoldutgkzaboqfk.supabase.co",
  "sb_publishable_Zs0J8nka95CzLZJ7BWqEAg_sqD5Wr0d"
);

/* CONFIG */
const bannedWords = ["nigger","nigga","fuck"];
const adminIDs = ["aa6e4111-dacb-48a1-bc10-7a71d20d79c3","58c564aa-70b0-4680-bf43-9252189ef42a"];
const mutedUsers = [];

/* DEVICE ID */
function getDeviceID(){
  let id = localStorage.getItem("device_id");
  if(!id){
    id = crypto.randomUUID();
    localStorage.setItem("device_id", id);
  }
  return id;
}
const deviceID = getDeviceID();

/* ELEMENTS */
const messagesDiv = document.getElementById("messages");
const input = document.getElementById("msgInput");

/* CENSOR */
function censorMessage(text){
  let result = text;
  bannedWords.forEach(word=>{
    const r = new RegExp(word,"gi");
    result = result.replace(r,"#".repeat(word.length));
  });
  return result;
}

/* LOAD USER */
const { data: me } = await supabase
  .from("users")
  .select("Name,blocked")
  .eq("user_id",deviceID)
  .maybeSingle();

if(!me || me.blocked){
  document.body.innerHTML="<h1>You have been banned from DD Games for breaking the TOS.</h1>";
  throw new Error("Blocked");
}

/* SEND */
window.sendMessage = async function(){
  if(mutedUsers.includes(deviceID)) return alert("You are muted.");

  const text = input.value.trim();
  if(!text) return;

  const clean = censorMessage(text);

  await supabase.from("messages").insert({
    user_id: deviceID,
    content: clean
  });

  input.value="";
};

/* RENDER */
function renderMessage(m){
  const div=document.createElement("div");
  div.className="msg";

  const isAdmin = adminIDs.includes(m.user_id);

  div.innerHTML = `
    <b class="${isAdmin?'admin':''}">${m.user_id}</b>: ${m.content}
    ${adminIDs.includes(deviceID) ? `<button onclick="deleteMsg('${m.id}')">ðŸ—‘</button>`:""}
  `;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

/* DELETE */
window.deleteMsg = async function(id){
  await supabase.from("messages").delete().eq("id",id);
};

/* LOAD INITIAL */
async function loadMessages(){
  const { data } = await supabase
    .from("messages")
    .select("*")
    .order("created_at",{ascending:true});

  messagesDiv.innerHTML="";
  data.forEach(renderMessage);
}
loadMessages();

/* REALTIME */
supabase.channel("chat")
  .on("postgres_changes",{event:"INSERT",schema:"public",table:"messages"},payload=>{
    renderMessage(payload.new);
  })
  .on("postgres_changes",{event:"DELETE",schema:"public",table:"messages"},()=>{
    loadMessages();
  })
  .subscribe();

/* AUTO DELETE AFTER 6 HOURS */
setInterval(async ()=>{
  const sixHoursAgo = new Date(Date.now()-21600000).toISOString();
  await supabase.from("messages").delete().lt("created_at", sixHoursAgo);
}, 60000);

</script>
</body>
</html>