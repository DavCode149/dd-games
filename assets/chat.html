<!DOCTYPE html>
<html>
<head>
<title>Chat</title>
<style>
body{margin:0;font-family:Arial;background:#0f172a;color:white;display:flex;flex-direction:column;height:100vh}
#top{display:flex;gap:10px;padding:10px;background:#020617}
#messages{flex:1;overflow-y:auto;padding:10px}
.msg{background:#1e293b;padding:6px 10px;border-radius:8px;margin-bottom:5px}
.name{color:#38bdf8;font-weight:bold}
#typing{font-size:12px;color:#94a3b8;margin-left:10px}
#inputBar{display:flex;border-top:2px solid #1e293b}
input,select,button{padding:8px;border-radius:6px;border:none}
img,video{max-width:300px;border-radius:8px}
.hidden{display:none}
</style>
</head>
<body>

<div id="top">
  <button onclick="openCreate()">➕ Create Conversation</button>
  <select id="userDropdown" class="hidden"></select>
  <span id="typing"></span>
</div>

<div id="messages"></div>

<div id="inputBar">
  <input id="input" placeholder="Message..." />
  <button onclick="sendMsg()">Send</button>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
const supabase=createClient(
  "https://lqfcntoldutgkzaboqfk.supabase.co",
  "sb_publishable_Zs0J8nka95CzLZJ7BWqEAg_sqD5Wr0d"
);

/* DEVICE */
let myID=localStorage.getItem("device_id");
if(!myID){myID=crypto.randomUUID();localStorage.setItem("device_id",myID);}

/* ME */
const { data:me }=await supabase.from("users")
.select('"Name",premium,muted,blocked')
.eq("user_id",myID)
.maybeSingle();

if(!me||me.blocked){document.body.innerHTML="Blocked";throw"";}
if(!me.premium){document.body.innerHTML="Premium only";throw"";}

const input=document.getElementById("input");
if(me.muted){input.disabled=true;input.placeholder="Muted";}

/* PUBLIC CONVO */
let publicConvo;
const { data:pub }=await supabase.from("conversations")
.select("*").eq("is_public",true).maybeSingle();

if(!pub){
  const { data:newPub }=await supabase.from("conversations")
  .insert({is_public:true}).select().single();
  publicConvo=newPub;
}else publicConvo=pub;

let currentID=publicConvo.id;

/* PREMIUM USERS */
const { data:users }=await supabase.from("users")
.select('user_id,"Name",premium')
.eq("premium",true);

const dropdown=document.getElementById("userDropdown");

function buildDropdown(){
  dropdown.innerHTML="";
  users.forEach(u=>{
    if(u.user_id===myID) return;
    const opt=document.createElement("option");
    opt.value=u.user_id;
    opt.textContent=u.Name||u.user_id;
    dropdown.appendChild(opt);
  });
}
buildDropdown();

/* CREATE BUTTON */
window.openCreate=()=>{
  dropdown.classList.toggle("hidden");
};

/* GET OR CREATE DM */
async function getDM(other){
  const { data:mine }=await supabase.from("conversation_members")
  .select("conversation_id").eq("user_id",myID);

  for(const c of mine){
    const { data:m }=await supabase.from("conversation_members")
    .select("user_id").eq("conversation_id",c.conversation_id);
    if(m.length===2 && m.some(x=>x.user_id===other))
      return c.conversation_id;
  }

  const { data:newC }=await supabase.from("conversations")
  .insert({is_public:false}).select().single();

  await supabase.from("conversation_members").insert([
    {conversation_id:newC.id,user_id:myID},
    {conversation_id:newC.id,user_id:other}
  ]);

  return newC.id;
}

/* SELECT USER */
dropdown.onchange=async()=>{
  const other=dropdown.value;
  currentID=await getDM(other);
  dropdown.classList.add("hidden");
  load();
};

/* CENSOR */
const bannedWords=["badword1","badword2"];
function censor(t){
  bannedWords.forEach(w=>{
    t=t.replace(new RegExp(w,"gi"),"#".repeat(w.length));
  });
  return t;
}

/* RENDER */
function render(txt){
  txt=txt.replace(/\*\*(.*?)\*\*/g,"<b>$1</b>")
         .replace(/\*(.*?)\*/g,"<i>$1</i>")
         .replace(/\n/g,"<br>");

  if(txt.match(/\.(gif|png|jpg|jpeg|webp)$/i))
    return `<img src="${txt}">`;
  if(txt.match(/\.(mp4|webm)$/i))
    return `<video src="${txt}" controls></video>`;
  return txt;
}

/* SEND */
window.sendMsg=async()=>{
  if(me.muted) return;
  const t=input.value.trim();
  if(!t) return;
  await supabase.from("messages").insert({
    conversation_id:currentID,
    user_id:myID,
    content:censor(t),
    read_by:[myID]
  });
  input.value="";
};

/* NAME CACHE */
const cache={};
async function nameOf(id){
  if(cache[id]) return cache[id];
  const { data }=await supabase.from("users")
  .select('"Name"').eq("user_id",id).maybeSingle();
  cache[id]=data?.Name||"User";
  return cache[id];
}

/* LOAD */
const box=document.getElementById("messages");
async function load(){
  const { data }=await supabase.from("messages")
  .select("*").eq("conversation_id",currentID)
  .order("created_at");

  box.innerHTML="";
  for(const m of data){
    const div=document.createElement("div");
    div.className="msg";
    const n=await nameOf(m.user_id);
    const read=m.read_by?.length>1?" ✔✔":" ✔";
    div.innerHTML=`<span class="name">${n}</span>: ${render(m.content)} ${read}`;
    box.appendChild(div);
  }
  box.scrollTop=box.scrollHeight;
}
load();

/* READ RECEIPTS */
setInterval(async()=>{
  const { data }=await supabase.from("messages")
  .select("id,read_by")
  .eq("conversation_id",currentID);

  for(const m of data){
    if(!m.read_by?.includes(myID)){
      await supabase.from("messages").update({
        read_by:[...(m.read_by||[]),myID]
      }).eq("id",m.id);
    }
  }
},3000);

/* REALTIME */
const typing=document.getElementById("typing");

supabase.channel("chat")
.on("postgres_changes",{event:"INSERT",table:"messages"},p=>{
  if(p.new.conversation_id!==currentID) return;
  load();
}).subscribe();

/* AUTO DELETE 6 HOURS */
setInterval(async()=>{
  const t=new Date(Date.now()-21600000).toISOString();
  await supabase.from("messages").delete().lt("created_at",t);
},60000);
</script>
</body>
</html>