<!DOCTYPE html>
<html lang="en-us">
  <head>
    <base href="https://cdn.jsdelivr.net/gh/genizy/cg-rip@main/steal-brainrot-online/">
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  </head>
  <body style="margin:0;padding:0" class="noselect">
      <!-- ▼ Dropdown menu toggle -->
<div class="menu-container">
  <div class="menu-toggle" onclick="toggleMenu()">▼</div>
  <div class="dropdown-menu" id="dropdownMenu">
    <button onclick="window.location.href='https://davcode149.github.io/dd-games/games.html'">Return</button>
  </div>
</div>

<style>
  /* Position menu at top center */
  .menu-container {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 1000;
  }

  /* The arrow toggle */
  .menu-toggle {
    background-color: rgba(255, 255, 255, 0.85);
    border: none;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    text-align: center;
    line-height: 30px;
    font-size: 18px;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    transition: background-color 0.2s, transform 0.2s;
  }

  .menu-toggle:hover {
    background-color: rgba(240, 240, 240, 0.95);
    transform: scale(1.1);
  }

  /* Dropdown panel */
  .dropdown-menu {
    display: none;
    position: absolute;
    top: 40px;
    right: 0;
    background-color: rgba(255, 255, 255, 0.9);
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    padding: 10px;
    min-width: 120px;
    text-align: center;
    animation: dropdownFade 0.2s ease;
  }

  /* Animation for fade-in */
  @keyframes dropdownFade {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .dropdown-menu button {
    width: 100%;
    padding: 8px 10px;
    border: none;
    border-radius: 6px;
    background-color: #007bff;
    color: white;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.3s;
  }

  .dropdown-menu button:hover {
    background-color: #0056b3;
  }
</style>

<script>
  function toggleMenu() {
    var menu = document.getElementById("dropdownMenu");
    menu.style.display = (menu.style.display === "block") ? "none" : "block";
  }

  // Optional: Close menu when clicking outside
  window.addEventListener("click", function(e) {
    if (!e.target.closest(".menu-container")) {
      document.getElementById("dropdownMenu").style.display = "none";
    }
  });
</script>
    <div id="loading-text" style="color: black; font-size: 48px; font-family: cursive; text-align: center; margin-top: 20px;">LOADING...</div>
    <canvas id="unity-canvas"
      style="position:fixed;top:0;left:0;width:100%;height:100%;outline:none"></canvas>

    <script>
    const SPLIT_MAP = {"StealMeme_Crazy.wasm": null};
    </script>

    <script>
    async function mergeParts(baseUrl) {
      const parts = [];
      for (let i = 1; i <= 99; i++) {
        const testUrl = baseUrl + ".part" + i;
        try {
          const head = await fetch(testUrl, { method: "HEAD" });
          if (!head.ok) break;
          parts.push(testUrl);
        } catch { break; }
      }
      if (parts.length === 0) return baseUrl;

      const buffers = await Promise.all(parts.map(async (u) => {
        const r = await fetch(u);
        if (!r.ok) throw new Error("Failed part " + u);
        return new Uint8Array(await r.arrayBuffer());
      }));

      const total = buffers.reduce((a, b) => a + b.length, 0);
      const merged = new Uint8Array(total);
      let offset = 0;
      for (const b of buffers) { merged.set(b, offset); offset += b.length; }

      return URL.createObjectURL(new Blob([merged]));
    }

    async function preMergeAll() {
      const map = {};
      const files = Object.entries(SPLIT_MAP);
      const total = files.length;
      let done = 0;

      const loadingText = document.getElementById("loading-text");

      for (const [file, _] of files) {
        const merged = await mergeParts("Build/" + file);
        map[file] = merged;
        done++;
        const percent = Math.floor((done / total) * 100);
        loadingText.innerText = `LOADING... ${percent}%`;
        console.log("Premerged:", file, "→", merged);
      }

      loadingText.style.display = "none";

      return map;
    }

    (async () => {
      const mergedMap = await preMergeAll();
      window.SPLIT_MAP = mergedMap;
      const origFetch = window.fetch;
      window.fetch = async function(resource, options) {
        if (typeof resource === "string") {
          const key = resource.split("/").pop();
          if (mergedMap[key]) {
            console.log("Redirect fetch:", key);
            return origFetch(mergedMap[key], options);
          }
          if (resource.includes("StreamingAssets")) {
            return origFetch((document.querySelector('base').href !== null ? document.querySelector('base').href+"/" : "") + "StreamingAssets/"+resource.split("/StreamingAssets/")[1])
          }
        }
        return origFetch(resource, options);
      };

      const OrigXHR = window.XMLHttpRequest;
      window.XMLHttpRequest = function() {
        const xhr = new OrigXHR();
        const origOpen = xhr.open;
        xhr.open = function(method, url, ...rest) {
          const key = url.split("/").pop();
          if (mergedMap[key]) {
            console.log("Redirect XHR:", key);
            origOpen.call(xhr, method, mergedMap[key], ...rest);
          } else {
            origOpen.call(xhr, method, url, ...rest);
          }
        };
        return xhr;
      };

      const canvas = document.querySelector("#unity-canvas");
      const loaderUrl = "Build/StealMeme_Crazy.loader.js";
      const config = {
        dataUrl: "Build/StealMeme_Crazy.data",
        frameworkUrl: "Build/StealMeme_Crazy.framework.js",
        codeUrl: "Build/StealMeme_Crazy.wasm",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "Steal Brainrot Online",
        productName: "Steal Brainrot Online",
        productVersion: "1.0.0"
      };

      const script = document.createElement("script");
      script.src = loaderUrl;
      script.onload = () => {
        createUnityInstance(canvas, config, (progress) => {}).then((unityInstance) => {
          window.gameInstance = unityInstance;
        }).catch((message) => alert(message));
      };
      document.body.appendChild(script);
    })();
    </script>

    <script>
    function resizeCanvas() {
      const canvas = document.getElementById("unity-canvas");
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      canvas.style.width = window.innerWidth + "px";
      canvas.style.height = window.innerHeight + "px";
    }
    window.addEventListener("load", resizeCanvas);
    window.addEventListener("resize", resizeCanvas);
    </script>
    <!-- Active User Tracker (No Display) -->
<script src="https://cdn.ably.io/lib/ably.min-1.js"></script>
<script>
  // === 1️⃣ Persistent browser ID ===
  let browserId = localStorage.getItem('ablyBrowserId');
  if (!browserId) {
    browserId = 'browser-' + Math.random().toString(36).substring(2, 10);
    localStorage.setItem('ablyBrowserId', browserId);
  }

  // === 2️⃣ Connect to Ably ===
  const ably = new Ably.Realtime({
    key: 'f4iV1g.CdzItg:DMBDb8oONqNtkeH6dq25U4DYKAfd-7GQ6uEKXuqUJVw',
    clientId: browserId
  });
  const channel = ably.channels.get('site-active-users');

  // === 3️⃣ Shared-tab logic (one connection per browser) ===
  const isMainTabKey = "ablyMainTabActive";
  const heartbeatKey = "ablyHeartbeat";
  const heartbeatInterval = 3000; // ms

  function setMainTab(active) {
    if (active) {
      localStorage.setItem(isMainTabKey, "true");
      localStorage.setItem(heartbeatKey, Date.now());
    } else {
      localStorage.removeItem(isMainTabKey);
      localStorage.removeItem(heartbeatKey);
    }
  }

  function isMainTab() {
    const lastBeat = parseInt(localStorage.getItem(heartbeatKey) || "0");
    return Date.now() - lastBeat < heartbeatInterval * 2;
  }

  // === 4️⃣ Keep heartbeat alive for main tab ===
  setInterval(() => {
    if (localStorage.getItem(isMainTabKey) === "true") {
      localStorage.setItem(heartbeatKey, Date.now());
    }
  }, heartbeatInterval);

  // === 5️⃣ Only first tab joins presence ===
  async function tryEnterPresence() {
    if (!isMainTab()) {
      setMainTab(true);
      try {
        await channel.attach();
        channel.presence.enter("online");
      } catch (err) {
        console.error("Error entering presence:", err);
      }
    }
  }

  // === 6️⃣ Detect other tabs closing/opening ===
  window.addEventListener("storage", async (event) => {
    if (event.key === heartbeatKey) {
      if (!isMainTab()) {
        tryEnterPresence();
      }
    }
  });

  // === 7️⃣ Leave presence when main tab closes ===
  window.addEventListener("beforeunload", () => {
    if (isMainTab()) {
      channel.presence.leave("online");
      setMainTab(false);
    }
  });

  // === 8️⃣ Connect ===
  ably.connection.once("connected", tryEnterPresence);
</script>
  </body>
</html>

