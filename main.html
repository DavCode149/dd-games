<!DOCTYPE html>
<html>
<head>
<title>DD Games</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<style>
body {
  margin:0;
  font-family: Arial, sans-serif;
  background: linear-gradient(270deg,#6a11cb,#2575fc);
  background-size:400% 400%;
  animation:bg 8s ease infinite;
  color:white;
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}

@keyframes bg {
  0%{background-position:0% 50%}
  50%{background-position:100% 50%}
  100%{background-position:0% 50%}
}

.hidden { display:none; }

#screen {
  width:100%;
  height:100%;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  text-align:center;
}

input, button {
  padding:12px;
  border-radius:10px;
  border:none;
  font-size:16px;
  margin-top:10px;
}

button {
  background:#00d4ff;
  cursor:pointer;
  min-width:200px;
}

#weather { margin-top:10px; }
#time { font-size:18px; margin-top:5px; }

.panel {
  background:rgba(0,0,0,.4);
  padding:30px;
  border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.3);
}
</style>
</head>

<body>

<div id="screen">

<div id="loading" class="panel">
  <img src="/dd-games/assets/logo-transparent.png" width="350" height="350">
  <h2 id="loaderText">Loading...</h2>
</div>

<div id="setup" class="panel hidden">
  <h2>Account Setup</h2>
  <input id="nameInput" placeholder="Enter your name">
  <button onclick="createAccount()">Create Account</button>
</div>

<div id="main" class="panel hidden">
  <img src="/dd-games/assets/logo-transparent.png" width="350" height="350">
  <h1 id="welcome"></h1>
  <div id="time"></div>
  <div id="weather"></div>
  <br>
  <button onclick="launchSite()">Launch Site</button>
  <button onclick="openAccount()">Account</button>
</div>

<div id="account" class="panel hidden">
  <h2>Account Info</h2>
  <p>User ID: <span id="uid"></span></p>
  <p>Device: <span id="device"></span></p>
  <p>OS: <span id="os"></span></p>
  <p>Browser: <span id="browser"></span></p>
  <p>IP: <span id="ipSpan"></span></p>

  <input id="editName">
  <button onclick="saveName()">Save Name</button>
  <button onclick="backMain()">Back</button>
</div>

<div id="noAccess" class="panel hidden">
  <h1>Access Pending</h1>
  <div>You currently do not have Access to the site. Please request Access via this form. Any info needed can be found on the Account page.</div>
  <br>
  <button onclick="RequestForm()">Request Access</button>
  <button onclick="backMain()">Go Back</button>
</div>

</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://lqfcntoldutgkzaboqfk.supabase.co",
  "sb_publishable_Zs0J8nka95CzLZJ7BWqEAg_sqD5Wr0d"
);

const loading = el("loading");
const setup = el("setup");
const main = el("main");
const account = el("account");
const noAccess = el("noAccess");

function el(id){ return document.getElementById(id); }

function show(el){
  [loading,setup,main,account,noAccess].forEach(e=>e.classList.add("hidden"));
  el.classList.remove("hidden");
}

/* DEVICE ID — MATCHES management.js */
function getDeviceID(){
  let id = localStorage.getItem("device_id");
  if(!id){
    id = crypto.randomUUID();
    localStorage.setItem("device_id", id);
  }
  return id;
}

/* DEVICE INFO */
function getInfo(){
  return {
    browser: navigator.userAgent,
    os: navigator.platform,
    device: /Mobi/.test(navigator.userAgent) ? "Mobile" : "Desktop",
    page: location.pathname
  };
}

const deviceID = getDeviceID();
const info = getInfo();
let userRow = null;
let ipAddr = "";

/* START */
setTimeout(init, Math.random()*4000+1000);

async function init(){
  const ipRes = await fetch("https://api.ipify.org?format=json");
  ipAddr = (await ipRes.json()).ip;

  let { data } = await supabase
    .from("users")
    .select("*")
    .eq("user_id", deviceID)
    .maybeSingle();

  if(!data){
    await supabase.from("users").insert({
      user_id: deviceID,
      ip: ipAddr,
      browser:info.browser,
      os:info.os,
      device:info.device,
      page:info.page,
      last_seen:new Date(),
      visit_count:1,
      blocked:false,
      Name:""
    });
    show(setup);
    return;
  }

  userRow = data;

  if(userRow.blocked){
    document.body.innerHTML="<h1>You have been Blocked for breaking DD Games' TOS.";
    return;
  }

  await supabase.from("users").update({
    ip: ipAddr,
    browser:info.browser,
    os:info.os,
    device:info.device,
    page:info.page,
    last_seen:new Date(),
    visit_count:(userRow.visit_count||0)+1
  }).eq("user_id",deviceID);

  if(!userRow.Name || userRow.Name.trim()===""){
    show(setup);
  } else {
    showMain();
  }
}

/* CREATE ACCOUNT */
window.createAccount = async function(){
  const msgs=["Polishing Games...","Refreshing Data...","Creating Account...","Almost Done..."];
  let i=0;
  show(loading);
  const t=setInterval(()=>{
    loaderText.textContent=msgs[i++%msgs.length];
  },800);

  await new Promise(r=>setTimeout(r,6000));
  clearInterval(t);

  const name=nameInput.value;
  await supabase.from("users").update({Name:name}).eq("user_id",deviceID);
  userRow.Name=name;
  showMain();
}

/* MAIN */
function showMain(){
  show(main);
  welcome.textContent="Welcome, "+userRow.Name;

  setInterval(()=>{
    time.textContent=new Date().toLocaleString();
  },1000);

  loadWeather();
}

/* WEATHER */
async function loadWeather(){
  const res = await fetch("https://api.codetabs.com/v1/weather");
  const w = await res.json();
  weather.textContent =
    `${w.city}, ${w.country}: ${Math.round(w.tempC)}°C (${Math.round(w.tempF)}°F)`;
}

/* ACCOUNT */
window.openAccount=function(){
  show(account);
  uid.textContent=deviceID;
  device.textContent=info.device;
  os.textContent=info.os;
  browser.textContent=info.browser;
  ipSpan.textContent=ipAddr;
  editName.value=userRow.Name;
  editName.placeholder=userRow.Name;
}

window.saveName=async function(){
  const newName=editName.value;
  await supabase.from("users").update({Name:newName}).eq("user_id",deviceID);
  userRow.Name=newName;
  showMain();
}

window.backMain=function(){ showMain(); }

/* LAUNCH */
window.launchSite=function(){
  if(!userRow.Access){
    show(noAccess)
    return;
  } else {
  document.body.style.margin = "0";
  document.body.style.height = "100vh";

  document.body.innerHTML = `
    <iframe 
      src="/dd-games/list.html"
      style="border:none; width:100vw; height:100vh;"
    ></iframe>
  `;
  }
}
window.RequestForm=function(){
  window.open(URL="https://forms.cloud.microsoft/r/5tJyGVcM1M")
}
</script>

</body>
</html>