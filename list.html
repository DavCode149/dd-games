<!DOCTYPE html>
<html>
<head>
  <title>Classroom</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<style>
body {
  margin: 0;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  background: linear-gradient(270deg, #6a11cb, #2575fc);
  background-size: 400% 400%;
  animation: gradientMove 3s ease infinite;
  font-family: Arial, sans-serif;
}

@keyframes gradientMove {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

/* Controls */
.controls {
  margin-top: 80px;
  display: flex;
  gap: 10px;
}

.controls input, .controls select {
  padding: 8px 12px;
  border-radius: 8px;
  border: none;
  font-size: 16px;
}

/* Grid */
.grid-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 20px;
  width: 90%;
  max-width: 1000px;
  padding: 20px;
}

/* Items */
.grid-item {
  background-color: rgba(255,255,255,0.9);
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
  text-align: center;
  cursor: pointer;
  overflow: hidden;
  opacity: 0;
  transform: translateY(10px);
  animation: fadeIn 0.5s ease forwards;
}

.grid-item:hover {
  transform: scale(1.05);
}

@keyframes fadeIn {
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.grid-item img {
  width: 100%;
  height: 150px;
  object-fit: cover;
}

.grid-item h3 {
  margin: 10px;
}

.back-button {
  top: 20px;
  left: 20px;
  background: #007bff;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 10px 20px;
  cursor: pointer;
}

/* STACK SECTIONS VERTICALLY IN GRID CONTAINER */
.section {
  grid-column: 1 / -1; /* full width */
  display: flex;
  flex-direction: column;
  gap: 12px; /* spacing between games */
  margin-bottom: 30px; /* spacing between sections */
}

/* ===== POPUP ===== */
#popupOverlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: flex;
  justify-content: center;
  align-items: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.4s ease;
  z-index: 9999;
}
#popupOverlay.show {
  opacity: 1;
  pointer-events: auto;
}
#popupBox {
  background: white;
  border-radius: 14px;
  padding: 30px 35px;
  width: min(500px, 85%);
  text-align: center;
  box-shadow: 0 10px 25px rgba(0,0,0,0.25);
  transform: scale(0.9);
  transition: transform 0.4s ease;
}
#popupOverlay.show #popupBox {
  transform: scale(1);
}
#popupBox button {
  margin-top: 20px;
  padding: 10px 20px;
  border-radius: 8px;
  border: none;
  background: #2575fc;
  color: white;
  cursor: pointer;
}

/* ===== COUNTER BADGE ===== */
#userCounter {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: rgba(0,0,0,0.75);
  color: white;
  padding: 8px 14px;
  border-radius: 20px;
  font-size: 14px;
  z-index: 9998;
}
</style>

<script src="https://cdn.ably.io/lib/ably.min-1.js"></script>

<script>
function brainrot() {
  alert("WARNING: These games may result in loss of braincells!");
  window.location.assign("https://davcode149.github.io/dd-games/0-games/0-brainrot/select.html");
}
</script>
</head>

<body>

<button class="back-button" onclick="window.location.href='https://davcode149.github.io/dd-games/main.html'">‚Üê Back</button>
<script>
  atOptions = {
    'key' : 'a19f6c85731f299418a7856e52d88a41',
    'format' : 'iframe',
    'height' : 90,
    'width' : 728,
    'params' : {}
  };
</script>
<script src="https://www.highperformanceformat.com/a19f6c85731f299418a7856e52d88a41/invoke.js"></script>
<h2 style="color:white;margin-top:30px;">Quick Links</h2>
<div class="grid-container" id="quickLinks">

  <div class="grid-item" onclick="window.location.href='https://forms.cloud.microsoft/Pages/ResponsePage.aspx?id=Jrm3b-vtT02C6AwQ5Ee1cNLNR-GLk9tJrwn7dwbdJRtUM0FXU0JTWTExME9PM1U3T1ZHS1lSSlJJRy4u'">
    <img src="/dd-games/assets/images/request.jpg">
    <h3>üéÆ Request a Game</h3>
  </div>

  <div class="grid-item" onclick="window.location.href='/dd-games/assets/premium-info.html'">
    <img src="/dd-games/assets/logo.png">
    <h3>üåü DD Games Premium</h3>
  </div>

  <div class="grid-item" onclick="window.location.href='/dd-games/assets/leaderboard.html'">
    <img src="/dd-games/assets/logo.png">
    <h3> Leaderboard</h3>
  </div>
</div>
<div class="controls">
  <input type="text" id="searchInput" placeholder="Search games...">
  <select id="sortSelect">
    <option value="az">Sort A‚ÄìZ</option>
    <option value="za">Sort Z‚ÄìA</option>
  </select>
</div>

<div class="grid-container" id="gameGrid"></div>

<!-- POPUP -->
<div id="popupOverlay">
  <div id="popupBox">
    <h2 id="popupTitle"></h2>
    <p id="popupDesc"></p>
    <button onclick="dismissPopup()">Dismiss</button>
  </div>
</div>

<script>
let allGames = [];
let isPremiumUser = false;

/* ===== USER FETCH ===== */
async function loadUser() {
  let myID = localStorage.getItem("device_id");
  if (!myID) {
    myID = crypto.randomUUID();
    localStorage.setItem("device_id", myID);
  }

  try {
    const res = await fetch(
      "https://lqfcntoldutgkzaboqfk.supabase.co/rest/v1/users?user_id=eq." + myID,
      {
        headers: {
          "apikey": "sb_publishable_Zs0J8nka95CzLZJ7BWqEAg_sqD5Wr0d"
        }
      }
    );
    const me = await res.json();
    isPremiumUser = me && me[0]?.premium ? true : false;
  } catch (err) {
    console.error("Failed to load user:", err);
  }
}

/* ===== GAMES FETCH ===== */
async function loadGames() {
  await loadUser();

  try {
    const res = await fetch("/dd-games/assets/games.json?v=" + Date.now(), {
      cache: "no-store"
    });
    if (!res.ok) throw new Error("HTTP_" + res.status);

    const data = await res.json();
    if (!Array.isArray(data)) throw new Error("NOT_ARRAY");

    allGames = data;
    renderGames();
  } catch (err) {
    showErrorPopup(err.message);
  }
}

/* ===== RENDER GAMES ===== */
function renderGames() {
  const grid = document.getElementById("gameGrid");
  const search = document.getElementById("searchInput").value.toLowerCase();
  const sort = document.getElementById("sortSelect").value;

  let filtered = allGames.filter(g => g.name.toLowerCase().includes(search));

  filtered.sort((a, b) =>
    sort === "az" ? a.name.localeCompare(b.name) : b.name.localeCompare(a.name)
  );

  grid.innerHTML = "";

  // CREATE SECTIONS
  const freeSection = document.createElement("div");
  const premiumSection = document.createElement("div");

  freeSection.className = "section";
  premiumSection.className = "section";

  freeSection.innerHTML = `<h2 style="color:white;">üéÆ Free Games</h2>`;
  premiumSection.innerHTML = `<h2 style="color:gold;">üåü Premium Games</h2>`;

  // ADD GAMES TO SECTIONS
  filtered.forEach(game => {
    const item = document.createElement("div");
    item.className = "grid-item";

    const img = document.createElement("img");
    img.src = game.image;

    const title = document.createElement("h3");
    title.textContent = game.name;

    item.appendChild(img);
    item.appendChild(title);

    if (game.premium) {
      if (isPremiumUser) {
        item.onclick = () => window.location.href = game.link;
        premiumSection.appendChild(item);
      }
    } else {
      item.onclick = () => window.location.href = game.link;
      freeSection.appendChild(item);
    }
  });

  // APPEND SECTIONS VERTICALLY
  grid.appendChild(freeSection);

  if (isPremiumUser) {
    grid.appendChild(premiumSection);
  } else {
    const locked = document.createElement("div");
    locked.className = "section";
    locked.innerHTML = `
      <h2 style="color:gold;">üîí Premium Games</h2>
      <p style="color:white;">
        Unlock exclusive games with DD Games Premium!
      </p>
      <button onclick="window.location.href='premium-info.html'"
        style="padding:10px 16px;border:none;border-radius:8px;background:gold;cursor:pointer;">
        Get Premium ‚Äì $3.50/month
      </button>
    `;
    grid.appendChild(locked);
  }
}
/* ===== POPUP ===== */
const popupTitleText = "‚ö†Ô∏è IMPORTANT: PLEASE READ ‚ö†Ô∏è";
const popupDescText = "Due to our recent breach, we're adding a lot of new security features to prevent one from happening again. We're now requiring that you use your REAL name for the site. This is so we can get rid of Leakers who are staying annoymous, if you lose access, just simply use the request form to confirm your identity and get your access back. Thank you for understanding.";
const popupExpireTime = "2026-02-26T23:59:59";

function showPopupIfValid() {
  if (!popupTitleText || !popupDescText) return;
  if (popupExpireTime && new Date() > new Date(popupExpireTime)) return;
  document.getElementById("popupTitle").textContent = popupTitleText;
  document.getElementById("popupDesc").textContent = popupDescText;
  document.getElementById("popupOverlay").classList.add("show");
}

function dismissPopup() {
  document.getElementById("popupOverlay").classList.remove("show");
}

showPopupIfValid();

/* ===== ERROR POPUP ===== */
function showErrorPopup(code) {
  document.getElementById("popupTitle").textContent = "An error has occurred.";
  document.getElementById("popupDesc").textContent = "Error code: " + code;
  document.getElementById("popupOverlay").classList.add("show");
}

/* ===== SEARCH & SORT EVENTS ===== */
document.getElementById("searchInput").addEventListener("input", renderGames);
document.getElementById("sortSelect").addEventListener("change", renderGames);

/* ===== INITIAL LOAD & INTERVAL ===== */
loadGames();
setInterval(loadGames, 60000);

/* ===== ABLY LIVE USER COUNTER ===== */
let browserId = localStorage.getItem('ablyBrowserId');
if (!browserId) {
  browserId = 'browser-' + Math.random().toString(36).substring(2, 10);
  localStorage.setItem('ablyBrowserId', browserId);
}

const ably = new Ably.Realtime({
  key: 'f4iV1g.CdzItg:DMBDb8oONqNtkeH6dq25U4DYKAfd-7GQ6uEKXuqUJVw',
  clientId: browserId
});

const channel = ably.channels.get('site-active-users');

const isMainTabKey = "ablyMainTabActive";
const heartbeatKey = "ablyHeartbeat";
const heartbeatInterval = 3000;

function setMainTab(active) {
  if (active) {
    localStorage.setItem(isMainTabKey, "true");
    localStorage.setItem(heartbeatKey, Date.now());
  } else {
    localStorage.removeItem(isMainTabKey);
    localStorage.removeItem(heartbeatKey);
  }
}

function isMainTab() {
  const lastBeat = parseInt(localStorage.getItem(heartbeatKey) || "0");
  return Date.now() - lastBeat < heartbeatInterval * 2;
}

setInterval(() => {
  if (localStorage.getItem(isMainTabKey) === "true") {
    localStorage.setItem(heartbeatKey, Date.now());
  }
}, heartbeatInterval);

async function tryEnterPresence() {
  if (!isMainTab()) {
    setMainTab(true);
    try {
      await channel.attach();
      channel.presence.enter("online");
    } catch (err) {
      console.error("Error entering presence:", err);
    }
  }
}

window.addEventListener("storage", async (event) => {
  if (event.key === heartbeatKey && !isMainTab()) {
    tryEnterPresence();
  }
});

window.addEventListener("beforeunload", () => {
  if (isMainTab()) {
    channel.presence.leave("online");
    setMainTab(false);
  }
});

const counter = document.createElement("div");
counter.id = "userCounter";
Object.assign(counter.style, {
  position: "fixed",
  bottom: "15px",
  right: "15px",
  display: "flex",
  alignItems: "center",
  gap: "8px",
  padding: "8px 14px",
  background: "linear-gradient(90deg, #2575fc, #6a11cb)",
  color: "white",
  fontFamily: "Arial, sans-serif",
  fontSize: "14px",
  borderRadius: "12px",
  boxShadow: "0 2px 8px rgba(0,0,0,0.2)",
  zIndex: "999",
  opacity: "0.9",
  transition: "opacity 0.3s ease"
});
counter.innerHTML = `
  <div id="statusDot" style="
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background-color: limegreen;
    box-shadow: 0 0 6px 2px rgba(0,255,0,0.5);
    animation: pulse 1.5s infinite;
  "></div>
  <span id="userText">Connecting...</span>
`;
document.body.appendChild(counter);

const style = document.createElement("style");
style.textContent = `
@keyframes pulse {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.3); opacity: 0.7; }
}
`;
document.head.appendChild(style);

function updateCount() {
  channel.presence.get((err, members) => {
    if (err) return;
    const unique = new Set(members.map(m => m.clientId));
    const count = unique.size;
    document.getElementById("userText").textContent =
      `${count} user(s) online`;
  });
}

channel.presence.subscribe("enter", updateCount);
channel.presence.subscribe("leave", updateCount);
setTimeout(updateCount, 1500);

counter.addEventListener("mouseenter", () => counter.style.opacity = "1");
counter.addEventListener("mouseleave", () => counter.style.opacity = "0.9");

ably.connection.once("connected", tryEnterPresence);
</script>
<script type="module" src="/dd-games/assets/management.js"></script>
</body>
</html> 